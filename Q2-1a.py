import numpy as np
import math
from cvxopt import solvers
from cvxopt import matrix
import timeit


with open("train.csv") as f1:
    x = np.genfromtxt(f1, delimiter=',')

#print(x.shape) #(22500, 785)
#print(x[:,-1])
y=x[:,-1]
x=x[:,:-1]/255.0
x1=x[(y==4,)]
x2=x[(y==5,)]
#y1=y[(y==4)]
#y2=y[(y==5)]
#y=np.concatenate((y1, y2), axis=0)

#print(X.shape) #(4500, 784)
x1=(-1)*x1
n1=x1.shape[0]
n2=x2.shape[0]
m=n1+n2
X=np.concatenate((x1, x2), axis=0)
Y=np.concatenate((np.ones((n1,1)),np.ones((n2,1))*(-1.0)),axis=0)

starttime = timeit.default_timer()

P=np.dot(X,X.T)#*np.outer(Y,Y)
q=np.ones((m,1))*(-1.0)
G=np.concatenate((np.identity(m),(np.identity(m))*(-1.0)),axis=0)
h=np.concatenate((np.ones((m,1)),np.zeros((m,1))),axis=0)
A=Y.T 

b=np.array([[0.0]])

P=matrix(P, tc='d')
q=matrix(q, tc='d')
G=matrix(G, tc='d')
h=matrix(h, tc='d')
A=matrix(A, tc='d')
b=matrix(b, tc='d')


sol=solvers.qp(P,q,G,h,A,b)

sol=sol['x']

w=np.dot(sol.T,X)

n_support=np.zeros((2,))
for i in range(m):
    if(sol[i]>0.00001):
        if(i<n1):
            b=-1+np.dot(w,X[i].T)
            break
        else:
            b=1-np.dot(w,X[i].T)
            break

for i in range(m):
    if(sol[i]>0.00001):
        if(i<n1):
            n_support[0]=n_support[0]+1
        else:
            n_support[1]=n_support[1]+1
            
print("training time:")
print(timeit.default_timer()-starttime)
print('b:')
print(b)
print('w:')
print(w)
print('no of support vectors:')
print(n_support)


with open("test.csv") as f1:
    x = np.genfromtxt(f1, delimiter=',')
y=x[:,-1]
x=x[:,:-1]/255.0
x1=x[(y==4,)]
x2=x[(y==5,)]
#y1=y[(y==4)]
#y2=y[(y==5)]
#y=np.concatenate((y1, y2), axis=0)
X=np.concatenate((x1, x2), axis=0)

t1=x1.shape[0]
t2=x2.shape[0]
t=t1+t2

correct=0.0

for i in range(t):
    if(i<t1):
        if (((np.dot(w,X[i].T))+b)<0.0):
            correct=correct+1 
        else:
            print(i)
    else:
        if (((np.dot(w,X[i].T))+b)>0.0):
            correct=correct+1
        else:
            print(i)

print("correct:")
print(correct)
print("total:")
print(t)
print('accuracy:')  
print(correct*100/t)

#w:
#[[ 0.00000000e+00  0.00000000e+00 -1.41562757e-04 -1.41562757e-04
#  -1.41562757e-04 -4.24688271e-04 -7.56373151e-14 -1.67048327e-03
#  -2.82013428e-03 -1.56657878e-03  1.86524053e-02 -2.04271640e-02
#  -1.17409845e-01 -6.23268314e-02 -7.11134081e-02 -9.92583563e-02
#  -5.10509864e-02  4.00353211e-04 -2.33402969e-02  2.73124482e-02
#   2.88265714e-02  2.95458831e-02  1.30663439e-02  1.42186625e-11
#   4.81064791e-04  6.82855121e-12  3.57109908e-12  1.41219612e-13
#  -1.22044565e-03 -1.22044565e-03 -1.22044565e-03 -1.22044565e-03
#  -1.70862391e-03 -1.96421080e-03 -3.53904999e-03 -8.91061696e-03
#  -8.98100526e-03 -3.36799216e-02 -6.41757710e-02 -6.37578649e-02
#  -1.98441201e-01 -1.63320524e-01 -1.47929974e-01 -1.37483206e-01
#  -6.07743110e-03 -1.91402285e-02  2.03926695e-02  2.37056817e-02
#   5.94343950e-02  8.77324999e-02  5.76042928e-02  1.08476913e-02
#  -2.08842666e-03 -3.41226247e-03 -3.39477951e-03 -3.66133695e-03
#  -1.22044565e-03 -1.22044565e-03 -1.22044565e-03 -1.27989799e-03
#  -1.70862391e-03 -3.08879313e-03 -1.91364249e-02 -3.25788792e-02
#  -6.84158471e-02 -9.63911322e-02 -4.29736677e-02  4.32353192e-03
#  -6.76237575e-02 -2.05787747e-01 -2.43702083e-01 -9.09795233e-02
#   3.78278994e-02 -2.08561040e-02 -7.72168733e-03 -3.07576580e-02
#   1.69003912e-02  6.57495015e-02  6.85792258e-02  5.50633578e-02
#   2.93006811e-02  1.00320562e-02 -1.47205237e-03 -3.41724782e-03
#  -1.22044565e-03 -1.22044565e-03 -1.64513392e-03 -2.30364522e-03
#  -3.90667118e-03 -2.77056597e-02 -6.04767655e-02 -6.72251008e-02
#  -1.01545771e-01 -6.32939459e-02 -1.36628089e-02 -4.02353993e-02
#   1.08034634e-03 -1.31630136e-01 -2.41320709e-01 -1.27686591e-02
#   1.11353339e-02  3.86826409e-03 -2.11872866e-02 -1.90125861e-02
#  -2.45694085e-02  6.90655134e-02  6.72725207e-02  8.39099634e-02
#   5.09788075e-02  2.28063594e-02 -2.35618890e-03 -2.44790750e-03
#  -1.22044565e-03 -1.22044565e-03 -1.42170972e-03 -3.96400243e-03
#  -1.27267807e-02 -4.38850623e-02 -5.18751855e-02 -6.57195973e-02
#  -8.53310280e-02 -8.57112469e-02 -5.43801232e-02 -4.22996862e-02
#  -2.89134534e-02 -5.42662560e-02 -5.01488396e-02 -1.47265781e-02
#  -2.60134883e-02 -1.06610273e-02 -1.10344134e-02  3.58480988e-04
#  -8.42595577e-03  5.77212646e-02  3.83508106e-02  4.64014956e-02
#   3.84255335e-02  6.11868808e-03 -1.28606236e-03 -2.90022836e-03
#  -1.22044565e-03 -1.22044565e-03 -1.25948203e-03 -7.35453106e-03
#  -2.59187809e-02 -5.38016101e-02 -5.92951360e-02 -5.75667842e-02
#  -1.07626603e-01 -1.56439481e-01 -1.18288432e-01 -3.90030264e-02
#  -1.46011610e-02 -4.59637777e-02 -3.34263149e-02 -4.69482939e-02
#  -4.67791018e-02 -4.91779741e-02  3.09014294e-02  3.14764536e-02
#   1.05232258e-02  9.54035694e-02  7.51707903e-02  9.83290436e-03
#   8.79666930e-03  6.97052542e-03  3.54168180e-03 -3.05588605e-03
#  -1.22044565e-03 -1.22044565e-03 -2.03832370e-03 -7.81458746e-03
#  -3.63477633e-02 -5.07450601e-02 -1.00734096e-01 -1.18992708e-01
#  -1.49930333e-01 -1.34967195e-01 -1.32922800e-01 -1.18647184e-01
#  -7.66263991e-03 -1.46448691e-01 -1.07839794e-01 -9.14290568e-05
#   5.01894308e-02  3.37328546e-02 -1.08933025e-03 -7.85949541e-02
#  -1.75612162e-02  4.69256469e-02  7.15768886e-02  1.66298175e-02
#   1.17331600e-02  3.49744351e-03  1.45046556e-03 -1.07485313e-03
#  -1.95320572e-03 -9.76356520e-04 -2.19167584e-03 -6.52002891e-03
#  -3.11878038e-02 -1.05465323e-01 -1.37934881e-01 -1.58227772e-01
#  -1.48128482e-01 -9.69814667e-02 -1.40540043e-01 -9.86339291e-02
#  -8.85903956e-02 -2.28990169e-02 -1.90945300e-02  6.37411171e-03
#  -2.12570627e-02  1.21659227e-02 -1.84777994e-02 -4.89627092e-02
#  -3.39918144e-02  1.15540907e-02  8.12354756e-03  3.78497728e-02
#   3.83227464e-02  2.82143262e-02  1.51342372e-02  7.91081216e-03
#  -8.58671952e-04 -7.81262322e-04 -1.07859128e-03 -2.91561146e-03
#  -4.47343410e-02 -1.32119598e-01 -1.22631532e-01 -1.63206046e-01
#  -1.73369567e-01 -1.09516725e-01 -1.14439601e-01 -2.95390351e-02
#  -4.76199665e-02 -2.42784266e-02  3.37780773e-03 -5.25455493e-02
#   2.47289475e-03  1.76329278e-02  1.60244047e-02 -6.22591751e-03
#  -5.41959292e-02  6.13256151e-02  2.33358831e-02  4.77216053e-02
#   3.14458702e-02  4.33632551e-02  8.40105192e-03  2.85130396e-04
#  -6.14582822e-04 -4.88178260e-04 -6.76483587e-04 -8.05224475e-03
#  -8.25339773e-02 -1.31628804e-01 -1.25507502e-01 -1.41218253e-01
#  -1.47448396e-01 -1.08255000e-01 -5.62129510e-02 -2.66894064e-03
#  -4.85327986e-03 -9.10063195e-02  1.59203187e-02  4.66071340e-02
#   1.00593448e-01  9.40853836e-02  7.71055720e-02 -1.43946842e-02
#  -3.03580981e-02 -4.58795971e-03 -3.00050872e-03  4.08564762e-02
#   4.20554466e-02  3.83912483e-02  3.60315370e-02  1.80917915e-02
#  -4.88178260e-04 -2.14879260e-03 -3.13967663e-03 -1.67032714e-02
#  -8.91985302e-02 -9.12902725e-02 -1.16411367e-01 -8.80007479e-02
#  -1.24554022e-01 -5.33708394e-02 -8.09760798e-02  3.64324454e-02
#   8.56133790e-03 -8.55911964e-02 -9.83445247e-02 -5.84955894e-02
#   4.36101463e-02  3.87919431e-02  5.07165156e-02 -4.89371060e-02
#   9.29851799e-03  3.49329059e-02 -1.22282080e-02  1.45293786e-02
#   9.66362920e-02  7.17183374e-02  6.46414279e-02  3.16002095e-02
#  -2.41764258e-04 -4.24933209e-04 -4.80241632e-03 -4.81076449e-02
#  -8.75466040e-02 -8.44381110e-02 -8.90856030e-02 -6.16848034e-02
#  -7.42355175e-02  1.42910443e-02  3.31879463e-02  6.71588608e-02
#   5.53606013e-02 -1.08677100e-02 -2.45775695e-02 -6.26118550e-02
#   1.71183941e-02  1.56556657e-02  2.41330154e-02 -2.17851457e-02
#   1.70052456e-02  4.93290129e-02 -7.37601682e-03  3.77203323e-02
#   7.14259681e-02  9.56377578e-02  9.06020442e-02  3.98424755e-02
#  -1.91546962e-04  9.18928983e-04  1.81794288e-02 -5.55498622e-02
#  -7.67173049e-02 -4.85462347e-02 -2.92865287e-03  3.73078786e-02
#  -2.91304776e-02  5.06887626e-02  6.86093417e-02  5.86618794e-02
#   4.09549811e-02  7.95167592e-02  8.94316145e-03 -1.89662138e-02
#   4.37784939e-02  7.54496361e-02  8.73957041e-02  1.63296252e-02
#   2.09559227e-02  3.74856891e-02 -3.09286225e-03  4.07164840e-02
#   2.04018751e-02  8.20725823e-02  7.69114610e-02  1.61669196e-02
#   1.11769936e-02  1.70772096e-02 -1.49999555e-03 -3.92449680e-02
#   2.82272352e-03  3.62058658e-02 -2.87159521e-02  4.20626024e-02
#  -2.28543725e-02  3.21404002e-02  8.96021129e-02  3.57910713e-02
#   2.65845060e-02 -1.79280167e-02  5.50175321e-02  3.16617679e-02
#   3.70599475e-02  1.44311091e-01  8.59348719e-02 -9.33736788e-03
#   3.28608442e-02 -1.33808788e-02  1.99861762e-02  1.62117835e-02
#  -1.92259111e-02  2.47143467e-02  6.72985304e-02  1.49049454e-02
#   3.12413166e-02  5.14975324e-02  1.39302269e-03 -2.98972469e-02
#   6.13556832e-02  2.07396675e-02 -1.81668378e-02  1.80290742e-02
#  -4.39214346e-02 -1.37690854e-01 -1.19201647e-01 -1.09010164e-01
#  -5.08561415e-02  2.26047283e-02  1.32331610e-02 -3.86441192e-02
#  -4.39538044e-02  3.24760017e-02 -1.35509604e-01 -1.82298928e-02
#   2.45813766e-02  2.85316181e-03  4.80826490e-02  2.85259210e-02
#   4.85655634e-02  3.35053185e-02  1.14765500e-01  3.02672830e-02
#   5.19792811e-02  4.49034488e-02 -2.83397742e-03 -1.28039778e-02
#   3.56222591e-02  8.84130706e-02 -5.06922480e-02  5.41890310e-03
#  -9.85524444e-03 -2.46834355e-02 -1.32359179e-02 -6.76620755e-02
#  -6.89014855e-02 -6.64999652e-02 -4.87299220e-02  4.13652166e-02
#  -3.40002620e-02  5.97310254e-02  5.22466334e-02  9.35245644e-02
#   6.65044345e-02  3.02097001e-02  5.52260327e-02  2.60979366e-02
#   8.40289430e-02  3.43699808e-02  1.08267024e-01  5.46261625e-02
#   2.45334890e-02  2.83449695e-02  2.05937548e-02  9.14214835e-03
#   4.15097139e-02  6.72455664e-02 -3.62137684e-02 -5.36197188e-02
#   5.59868889e-03  3.14386434e-02  2.84714245e-02  2.92710842e-02
#   3.75617083e-02  3.95053365e-02  8.08488251e-03 -4.06716705e-02
#   4.12291139e-02  8.13549402e-02  3.41987182e-02  4.30934340e-02
#   2.18355698e-03  1.66458216e-02  6.22412308e-02  2.63103811e-02
#   8.51169193e-02  4.91366157e-02  8.30661422e-02  5.11423202e-02
#   1.73012088e-03 -1.02662938e-02 -2.54493757e-02 -3.01979450e-02
#   1.88577390e-02  2.61762400e-02 -2.81252663e-02 -9.29104729e-02
#  -1.86476338e-02 -5.63126448e-03  2.82878211e-02  1.54370059e-02
#  -9.35928151e-05  9.88266487e-02  5.36287281e-02 -4.45598864e-02
#   4.01524859e-02  5.89912449e-02  8.97583001e-02  7.48552992e-02
#   4.93806356e-02 -4.61925699e-02  5.13824230e-02  2.77914170e-02
#   5.32387399e-02  4.95003743e-02  3.99535533e-02  8.39289975e-03
#   4.51907206e-02  8.37562184e-02  4.42639365e-02 -1.39263117e-02
#  -1.15816149e-02 -4.88624919e-03 -1.35979484e-02 -3.22251005e-02
#  -4.48114348e-02 -4.04224756e-02  1.20650452e-02  2.62598978e-02
#  -7.92650408e-03 -8.09837073e-04  2.51672824e-03  9.06391871e-03
#   7.02402659e-02  9.56605250e-02  3.13075411e-02  8.72883639e-02
#   7.77450633e-02 -3.33626055e-02  2.60881190e-02  3.88336157e-02
#   2.27370293e-02  5.88599747e-02  7.12291259e-02  4.11200492e-02
#   2.14292262e-02  3.76038435e-02  3.34920746e-02  3.20311409e-02
#  -2.11373252e-02 -5.94620150e-02 -2.20040479e-02 -3.03314525e-02
#  -2.13090409e-02 -5.17348783e-03 -6.60681361e-03  3.25997449e-02
#   5.52516763e-03  5.18337536e-03 -5.51169828e-02 -7.41534679e-02
#  -3.83413831e-02  5.47392196e-02  7.55528760e-02 -2.22547383e-02
#   1.80793406e-02 -6.22117230e-02 -2.96713707e-02  2.07479298e-02
#   4.38372100e-02  8.19453663e-02  6.24675654e-02  1.65015506e-02
#   3.72334499e-03  4.07044374e-02  2.06609773e-02  1.66492923e-02
#   2.29038012e-03 -1.66358106e-02  1.68188982e-02  2.26675549e-02
#  -7.95986411e-02 -7.12457168e-02  1.44025233e-02  1.74077023e-02
#  -6.66584582e-02  6.78559619e-03  2.45028447e-02 -6.60366386e-02
#  -5.53444103e-02  5.42966811e-02  2.42747795e-02 -7.05162712e-02
#   4.44077426e-02 -1.62764456e-03  2.64258298e-02  7.87621719e-02
#   4.68769957e-02  6.03430095e-02  2.75155855e-02 -7.08968593e-03
#   1.22712128e-02  4.23999188e-02 -5.10735669e-04 -7.56911665e-03
#  -4.91546044e-02 -7.52792305e-03  3.19534661e-02  4.07278092e-03
#  -1.02456652e-01 -7.71569813e-02  1.51882437e-03  2.76104383e-02
#  -2.87153013e-02 -6.95212356e-02 -7.34937536e-02 -7.07319242e-02
#   5.02713819e-03  1.74346270e-02 -4.86530688e-02 -8.84786222e-02
#  -7.15863586e-03 -1.84017408e-03  4.66539717e-02  3.14467243e-02
#   3.05504569e-02  4.37752339e-02  2.14972758e-02 -1.77603618e-03
#   2.19819114e-02  6.93946678e-02  4.02540173e-02  1.32732142e-02
#  -1.58240710e-03 -6.00439288e-03 -1.96395290e-02  1.32989404e-02
#  -2.06241217e-02 -3.59368616e-03 -1.24179347e-02 -5.57113750e-02
#  -6.40899906e-02  1.45412471e-02 -9.23165586e-02 -2.64920753e-02
#   4.24018238e-02 -7.35531823e-02 -9.11791517e-02 -1.07491012e-01
#  -3.00806537e-02  4.78310655e-03  7.86104021e-03  5.17671395e-02
#   3.27499416e-02  6.84359013e-02  3.30627936e-02  1.31293603e-02
#   1.37819048e-02  2.14490852e-02  3.25068609e-03  9.34077652e-03
#   1.89416448e-03 -5.80520998e-03 -1.23594968e-02  6.85542250e-02
#   6.69315237e-02 -2.77391032e-03  5.18396167e-02 -2.12803426e-02
#  -5.62585768e-02  2.64040172e-02  1.53401085e-02  1.45808256e-02
#  -3.48612628e-02 -1.33265344e-01 -9.16419095e-02 -4.37788716e-02
#  -4.39905518e-03 -2.72929565e-03 -2.10289573e-02  3.33226360e-02
#   1.85440783e-02  4.96004153e-02  1.61424712e-02  6.12964381e-03
#   9.89816320e-03  2.71279139e-02  7.11791087e-03 -1.31736677e-02
#  -2.26152055e-02 -4.20823543e-02 -4.99436863e-02  4.58674831e-02
#   5.02362190e-02 -8.94097836e-03  1.51110795e-02  5.08687078e-03
#  -2.05207716e-02 -2.14328374e-02  2.39176262e-02  5.40606114e-02
#  -6.54971348e-02 -7.46222969e-02 -4.51766078e-02 -3.65019479e-02
#  -3.31478919e-02 -2.63138945e-02 -6.07694085e-02  4.82625477e-03
#   9.45942881e-03  2.98437379e-02  5.69206872e-03 -6.74061551e-05
#   1.62200545e-03  5.27362251e-03  7.36377614e-03 -6.97499286e-03
#   1.19102612e-02  4.96019075e-02  3.51880932e-02  3.93734831e-02
#   5.05833110e-02 -2.55353470e-02 -5.05573172e-02  3.77142943e-03
#   1.49451005e-02  7.98277190e-03  7.80828442e-02 -1.14325113e-02
#  -5.71457243e-02 -5.81518796e-02 -3.59918120e-02 -3.32898371e-02
#  -5.43266821e-02 -3.98768153e-02 -3.91492680e-02  5.82486679e-03
#   3.18219642e-04  1.23215186e-02 -1.18628214e-02 -2.66805407e-03
#  -9.05661866e-04  6.86310795e-04  9.54140889e-03 -5.68767807e-03
#  -1.79672537e-02 -5.32572439e-03  3.06970774e-02  5.82766548e-02
#   6.82191443e-02 -4.34550030e-03 -2.40257115e-02  2.17081267e-03
#   6.55398276e-03 -2.56543392e-03 -1.15911711e-02 -6.28009335e-02
#  -9.68088848e-02 -8.28454960e-02 -5.16064392e-02 -5.45189691e-02
#  -3.02913104e-03 -7.52722623e-03 -2.63355341e-02  3.80443062e-02
#  -2.69693870e-02 -2.36520880e-02 -2.31277375e-02 -2.68498042e-03
#  -1.22044565e-03 -1.70862391e-03 -2.08944108e-03  1.26240462e-03
#  -8.39928167e-03 -3.86597630e-02 -1.09560765e-02  4.87272766e-02
#   4.61908439e-02  3.26089311e-02  3.03599040e-02  3.07601995e-02
#  -1.46372202e-02 -1.00512554e-02 -1.05576674e-02 -3.64808131e-02
#  -3.99929279e-02 -4.22611593e-02 -1.92517924e-02 -1.61594584e-04
#   1.25062888e-02  8.34155632e-03 -3.60530379e-02 -8.86006748e-03
#  -2.88327478e-02 -1.39285417e-02 -3.99808161e-03 -3.17315869e-03]]